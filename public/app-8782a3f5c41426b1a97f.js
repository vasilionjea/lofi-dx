(()=>{"use strict";function e(e){return null==e}function t(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function s(e,s){const n={};for(const r of Object.keys(e))t(s,r)&&(n[r]=e[r]);return n}function n(e,t){let s;for(let n=0;n<e.length;n++)if(e[n]===t){s=e.splice(n,1)[0];break}return s}new Map([["[object Undefined]","undefined"],["[object Null]","null"],["[object Boolean]","boolean"],["[object String]","string"],["[object Number]","number"],["[object Array]","array"],["[object Set]","set"],["[object Object]","object"],["[object Map]","map"],["[object Function]","function"],["[object RegExp]","regexp"],["[object Error]","error"]]);const r=["a","able","about","above","across","after","again","against","ain","all","am","an","and","any","are","aren","aren't","as","at","be","because","been","before","being","below","between","both","but","by","can","couldn","couldn't","d","did","didn","didn't","do","does","doesn","doesn't","doing","don","don't","down","during","each","few","for","from","further","had","hadn","hadn't","has","hasn","hasn't","have","haven","haven't","having","he","her","here","hers","herself","him","himself","his","how","i","if","in","into","is","isn","isn't","it","it's","its","itself","just","ll","m","ma","me","mightn","mightn't","more","most","mustn","mustn't","my","myself","needn","needn't","no","nor","not","now","o","of","off","on","once","only","or","other","our","ours","ourselves","out","over","own","re","s","same","shan","shan't","she","she's","should","should've","shouldn","shouldn't","so","some","such","t","than","that","that'll","the","their","theirs","them","themselves","then","there","these","they","this","those","through","to","too","under","until","up","ve","very","was","wasn","wasn't","we","were","weren","weren't","what","when","where","which","while","who","whom","why","will","with","won","won't","wouldn","wouldn't","y","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves"].reduce(((e,t)=>(e[t]=t,e)),{});function i(e){return function(e){return Boolean(r[e])}(e)||!e.match(/(\w+)/g)}function o(e){const t=[];for(const s of e.split(/\s+/g))i(s)||t.push(s);return t.join(" ")}var a;!function(e){e.Invalid="Invalid",e.PresenceTerm="PresenceTerm",e.ExactTerm="ExactTerm",e.Term="Term"}(a||(a={}));const c={[a.PresenceTerm]:/(?<PresenceTerm>(?:(\s+)?([-+]))((\w{2,})|"(?:[^"]+)"))/,[a.ExactTerm]:/(?<ExactTerm>("(?:[^"]+)"))/,[a.Term]:/(?<Term>[^ ]+)/},h=new RegExp(`${c[a.PresenceTerm].source}|${c[a.ExactTerm].source}|${c[a.Term].source}`,"g");class u{constructor(e,t){this.type=e,this.text=t}}class l{constructor(e){this.queryInvalidChars=/(?:[\^*()_}\]\\[{>\\<|\\/`~}]+)/gi,this.queryText=e.replace(this.queryInvalidChars,"")}getTokenType(e={}){let t=a.Invalid;return e.PresenceTerm?t=a.PresenceTerm:e.ExactTerm?t=a.ExactTerm:e.Term&&(t=a.Term),t}tokenize(){const e=[];for(const t of this.queryText.matchAll(h))if(t&&t.groups){const s=this.getTokenType(t.groups),n=(t[0]||"").trim();n&&!i(n)&&e.push(new u(s,n))}return e}}function d(e=""){return e.replace(/\s+/g," ").trim()}function m(e=""){return e.replace(/["]/g,"")}const p=/s$/i,f=/(ss|i?es)$/i;function g(e){const t=[];for(const s of e.split(/\s+/g))p.test(s)&&!f.test(s)?t.push(s.replace(p,"")):t.push(s);return t.join(" ")}var b;!function(e){e[e.Simple=0]="Simple",e[e.Negated=1]="Negated",e[e.Required=2]="Required"}(b||(b={}));class y{constructor(){this.parts=[]}add(e){this.parts.push(e)}}class v{constructor(e){this.tokens=e}parsePresence(e){let t=d(e.text.toLocaleLowerCase()).trim(),s=b.Simple,n=!1;return t.startsWith("-")?s=b.Negated:t.startsWith("+")&&(s=b.Required),t=function(e=""){return e.replace(/^([-+]+)/,"")}(t),t.startsWith('"')&&(t=m(t).trim(),n=!0),t=o(t),t=g(t),{term:t,type:s,isPhrase:n}}parseExact(e){let t=m(e.text.toLocaleLowerCase());return t=d(t).trim(),t=o(t),t=g(t),{term:t,type:b.Simple,isPhrase:!0}}parseSimple(e){return{term:g(e.text.toLocaleLowerCase().trim()),type:b.Simple,isPhrase:!1}}parse(){const e=new y;for(const t of this.tokens){let s;switch(t.type){case a.PresenceTerm:s=this.parsePresence(t);break;case a.ExactTerm:s=this.parseExact(t);break;default:s=this.parseSimple(t)}s.term&&e.add(s)}return e}}function T(e){const t=e.concat(),s=[];if(!t.length)return s;let n=parseInt(t.shift(),36);s.push(n);for(const e of t){const t=n+parseInt(e,36);s.push(t),n=t}return s}function w(e){if(!e)return{frequency:0,totalTerms:0,postings:[]};const[t,s]=e.split("/"),[n,r]=t.split(":");return{frequency:parseInt(n,36),totalTerms:parseInt(r,36),postings:T(s.split(","))}}function S(e){const{frequency:t,totalTerms:s}=e;return`${t.toString(36)}:${s.toString(36)}/${function(e){const t=[];if(!e.length)return t;for(let s=0;s<e.length;s++){const n=e[s-1],r=e[s];if(0===s)t.push(r.toString(36));else{const e=r-n;t.push(e.toString(36))}}return t}(e.postings).join(",")}`}const x=/\s+/g;class E{get totalDocs(){return this.totalDocuments}constructor(e){this.documentsTable={},this.tempDocTermCount={},this.totalDocuments=0,this.indexTable={},this.uidKey=e.uidKey||"id",this.fields=new Set(e.fields),this.documentSplitter=e.splitter||x}tokenizeText(e){return d(e).toLocaleLowerCase().split(this.documentSplitter)}tokensWithPostings(e){const t=[];let s=0;for(const n of e)if(!i(n)){const e=g(n),r={term:e,posting:s};s+=e.length+1,t.push(r)}return t}index(t){if(e(t)||!(s=t)||!/\S+/g.test(s))return this;var s;this.fields.add(t);for(const e of Object.values(this.documentsTable))this.indexDocument(t,e);return this}indexDocument(t,s){const n=s[this.uidKey];if(e(n))return;const r=this.tokensWithPostings(this.tokenizeText(s[t])),i=r.length,o=this.tempDocTermCount[n]||0;for(const e of r){this.indexTable[e.term]||(this.indexTable[e.term]={});const t=this.getDocumentEntry(e.term,n);t.frequency+=1,t.postings.push(e.posting),t.totalTerms=o?o+i:i,this.tempDocTermCount[n]=t.totalTerms,this.indexTable[e.term][n]=S(t)}}addDocuments(t){if(e(t)||!Array.isArray(t))return this;for(const e of t){const t=e[this.uidKey];this.documentsTable[t]=e,this.totalDocuments+=1}return this.fields.forEach((e=>this.index(e))),this.tempDocTermCount={},this}getDocument(e){return this.documentsTable[e]}getTermEntry(e){return this.indexTable[e]||{}}getDocumentEntry(e,t,s=!0){const n=this.getTermEntry(e);return s?w(n[t]):n[t]}toJSON(){return{fields:[...this.fields],documents:Object.assign({},this.documentsTable),index:Object.assign({},this.indexTable)}}}function j({frequency:e,totalTerms:t},{totalDocs:s,totalTermDocs:n}){const r=function(e,t){return e/t}(e,t),i=function(e,t){return Math.log(e/t)}(s,n);return r*i}class I{constructor(e){this.invertedIndex=e}matchesWithScores(e){const t={},s=Object.entries(e),n=this.invertedIndex.totalDocs,r=s.length;for(const[e,i]of s){const{frequency:s,totalTerms:o}=w(i);t[e]=j({frequency:s,totalTerms:o},{totalDocs:n,totalTermDocs:r})}return t}sumScores(...e){return e.reduce(((e=0,t=0)=>Number((e+t).toFixed(6))))}assignScores(e,s,n=!1){for(const[r,i]of Object.entries(s))n?t(e,r)&&(e[r]=this.sumScores(e[r],i)):e[r]=this.sumScores(e[r],i)}getSimpleMatches(e){const t=e&&this.invertedIndex.getTermEntry(e.term);return this.matchesWithScores(t)}getRequiredMatches(e){let t={};for(let n=0;n<e.length;n++){const r=e[n],i=r.isPhrase?this.getPhraseMatches(r):this.getSimpleMatches(r);if(!i){t={};break}if(0===n)t=i;else{const e=s(t,i);this.assignScores(e,i,!0),t=e}}return t}searchPhrase({candidates:t,terms:r}){const i={},o=r.length,a={};for(const s of Object.keys(t)){for(const e of r){const t=this.invertedIndex.getDocumentEntry(e,s);a[e]=t.postings}let t=0;const c=[a[r[0]].shift()];for(;c.length&&!e(r[t+1])&&i[s]!==o;){0===t&&(i[s]=1);const o=c[c.length-1]+r[t].length+1,h=n(a[r[t+1]],o);if(e(h)){t=0,c.length=0;const s=a[r[0]].shift();e(s)||c.push(s)}else c.push(h),i[s]+=1,t++}i[s]!==o&&delete i[s]}return s(t,i)}getPhraseMatches(e){const t=e.term.split(/\s+/);if(1===t.length)return this.getSimpleMatches(e);const s=this.getRequiredMatches(t.map((e=>({term:e,isPhrase:!1}))));return this.searchPhrase({terms:t,candidates:s})}getMatches(e){const t={};for(const s of e){const e=s.isPhrase?this.getPhraseMatches(s):this.getSimpleMatches(s);s.type===b.Negated?Object.assign(t,e):this.assignScores(t,e)}return t}result(e,s){const n=function(e,s){const n={};for(const r of Object.keys(e))t(s,r)||(n[r]=e[r]);return n}(e,s);return Object.keys(n).sort(((e,t)=>n[t]-n[e])).map((e=>this.invertedIndex.getDocument(e)))}search(e){const t=function(e){const t={required:[],negated:[],simple:[]};for(const s of e)switch(s.type){case b.Required:t.required.push(s);break;case b.Negated:t.negated.push(s);break;case b.Simple:t.simple.push(s)}return t}(function(e=""){if(!e)return new y;const t=new l(e).tokenize();return new v(t).parse()}(e).parts),s=this.getMatches(t.negated);return t.required.length?this.result(this.getRequiredMatches(t.required),s):this.result(this.getMatches(t.simple),s)}}const k=new class{constructor(){this.invertedIndex=new E({uidKey:"id",fields:["body"],splitter:/\W+|\d+/g}),this.invertedSearch=new I(this.invertedIndex)}async loadDocuments(){const e=await fetch("./data.json"),{data:t}=await e.json();this.invertedIndex.addDocuments(t),console.log(this.invertedIndex.toJSON())}search(e=""){if(e.length<=1)return;const t=performance.now(),s=this.invertedSearch.search(e),n=performance.now();return console.log(`Search took ${n-t} milliseconds.`),s}},q=e=>document.querySelector(e);class P extends Event{constructor(e){super("statechange"),this.state=e}}class C extends EventTarget{constructor(e={}){super(),this.value=e}setState(e){this.value=e,this.dispatchEvent(new P(this.value))}getState(){return this.value}}class D extends EventTarget{get tagName(){return"div"}get classNames(){return[]}constructor(e={}){super(),this.settings={},this.settings=Object.assign(Object.assign({},this.settings),e),this._createElement()}_createElement(){this.settings.element||(this.element=document.createElement(this.tagName)),this.element.classList.add(...this.classNames)}destroy(){this.element.remove(),this.element=this.settings=null}}class $ extends D{get classNames(){return["search-input"]}onInputChange(){this.inputElement.value?this.dispatchInput():this.dispatchClear()}dispatchInput(){const e=new CustomEvent("input:value",{bubbles:!0,detail:{value:this.inputElement.value}});this.dispatchEvent(e)}dispatchClear(){const e=new CustomEvent("input:clear",{bubbles:!0});this.dispatchEvent(e)}setValue(e){this.inputElement&&(this.inputElement.value=e,this.onInputChange())}clearIconTemplate(){return'<svg aria-hidden="true" viewBox="0 0 24 24" focusable="false" style="pointer-events: none; display: block; width: inherit; height: inherit" class=""><g><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"></path></g></svg>'}template(){const e="searchInput";let t=`<label id="prompt" for="${e}" class="visuallyhidden">Search national parks</label>`;return t+=`<input type="search" id="${e}" placeholder="Search for something..." aria-labelledby="prompt" autocorrect="off" spellcheck="false" autocapitalize="off">`,t+=`<button class="btn-icon btn-clear" aria-label="Clear search">${this.clearIconTemplate()}</button>`,t}render(){return this.element.insertAdjacentHTML("beforeend",this.template()),this.inputElement=this.element.querySelector("input"),this.btnClearElement=this.element.querySelector(".btn-clear"),this.inputElement&&this.inputElement.addEventListener("input",(()=>this.onInputChange())),this.btnClearElement&&this.btnClearElement.addEventListener("click",(e=>{var t;e.stopPropagation(),this.setValue(""),this.dispatchClear(),null===(t=this.inputElement)||void 0===t||t.focus()})),this}}class M extends D{get classNames(){return["search-results"]}resultsTemplate(e){return e.reduce(((e,t)=>e+`<article>${t.title}${t.body}</article>`),"")}noResultsTemplate(){return'<p class="no-results">No results found :(</p>'}render(e=[]){return this.element.innerHTML=e?e.length?this.resultsTemplate(e):this.noResultsTemplate():"",this}}new class extends C{constructor(e){super(),this.appService=e,this.$header=q("header"),this.$main=q("main"),this.$stats=q(".search-stats"),this.searchInput=new $,this.searchResults=new M,this.debouncedSearch=function(e,t=0,s){let n=null;return(...r)=>{n&&window.clearTimeout(n),n=window.setTimeout((()=>e.apply(s,r)),t)}}(this.search,150,this),this.addEventListener("statechange",this)}async start(){this.$header.prepend(this.searchInput.render().element),this.$main.append(this.searchResults.element);try{await this.appService.loadDocuments(),this.searchInput.addEventListener("input:value",this),this.searchInput.addEventListener("input:clear",this),this.searchInput.setValue('"sierra nevada" california')}catch(e){console.error(e)}}search(e){const t=this.appService.search(e);this.setState({results:t})}handleEvent(e){const{type:t,detail:s}=e;"input:value"===t&&this.debouncedSearch(s.value),"input:clear"===t&&this.setState({results:null}),"statechange"===t&&this.renderResults()}renderResults(){const{results:e}=this.getState();this.searchResults.render(e),this.$stats.textContent=e?`Total results: ${e.length}`:""}}(k).start()})();